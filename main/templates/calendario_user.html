<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario de Proyectos ‚Äì Candid-User</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-[#0b0b0e] text-[#e9e9ee] font-sans">
  <div class="max-w-7xl mx-auto px-6 py-6">
    
    <!-- HEADER -->
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">üìÖ Candid ‚Äì Calendario (Usuario)</h1>
      <div class="flex gap-2">
        <a href="{% url 'calendar_admin' %}" 
           class="bg-[#1b1b22] border border-gray-700 px-3 py-1 rounded-lg text-sm hover:bg-gray-800">
          Admin
        </a>
        <a href="{% url 'calendar_user' %}" 
           class="bg-[#1b1b22] border border-gray-700 px-3 py-1 rounded-lg text-sm hover:bg-gray-800">
          User
        </a>
      </div>
    </header>

    <!-- GRID -->
    <div class="grid md:grid-cols-2 gap-6">
      
      <!-- PANEL IZQUIERDO (FORM USUARIO) -->
      <section class="bg-[#121217] border border-gray-800 rounded-xl shadow-lg p-5">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Nuevo Proyecto (Usuario)</h3>
          <span class="text-xs px-2 py-1 rounded-full bg-[#1b1b22] border border-gray-700 text-gray-400">
            Usuario
          </span>
        </div>
        
        <form id="userProjectForm" class="space-y-4">
          <input type="hidden" id="projectId" />
          
          <div>
            <label class="block text-xs text-gray-400 mb-1">Nombre del proyecto</label>
            <input type="text" id="name" class="w-full px-3 py-2 rounded-lg bg-[#1b1b22] border border-gray-700 text-sm" placeholder="Ej. Sistema de Tickets">
          </div>

          <div>
            <label class="block text-xs text-gray-400 mb-1">Especificaci√≥n</label>
            <textarea id="spec" class="w-full px-3 py-2 rounded-lg bg-[#1b1b22] border border-gray-700 text-sm" placeholder="Descripci√≥n breve, alcance, stack‚Ä¶"></textarea>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs text-gray-400 mb-1">Usuario</label>
              <input type="text" id="usuario" class="w-full px-3 py-2 rounded-lg bg-[#1b1b22] border border-gray-700 text-sm">
            </div>
            <div>
              <label class="block text-xs text-gray-400 mb-1">√Årea</label>
              <input type="text" id="area" class="w-full px-3 py-2 rounded-lg bg-[#1b1b22] border border-gray-700 text-sm">
            </div>
          </div>

          <div>
            <label class="block text-xs text-gray-400 mb-1">Fecha de entrega</label>
            <input type="date" id="fechaEntrega" class="w-full px-3 py-2 rounded-lg bg-[#1b1b22] border border-gray-700 text-sm">
          </div>

          <div class="flex gap-2 flex-wrap mt-3">
            <button type="submit" class="bg-gradient-to-b from-[#ff2d55] to-[#b1152f] text-white px-4 py-2 rounded-lg text-sm">Enviar</button>
            <button type="button" id="btnClearUser" class="bg-[#1b1b22] border border-gray-700 px-4 py-2 rounded-lg text-sm">Limpiar</button>
          </div>
        </form>
      </section>

      <!-- PANEL DERECHO (CALENDARIO) -->
      <section class="bg-[#121217] border border-gray-800 rounded-xl shadow-lg p-5">
        <h3 class="text-lg font-semibold mb-4">Calendario</h3>
        <div id="calendar" class="rounded-lg overflow-hidden"></div>
      </section>
    </div>
  </div>
  
<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- CALENDARIO ---
  var calendarEl = document.getElementById('calendar');
  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 600,
    events: '/api/eventos/',
    eventClick: function(info) {
      const ev = info.event.extendedProps;
      Swal.fire({
        title: info.event.title,
        html: `
          <p><b>Fecha inicio:</b> ${info.event.startStr || "‚Äî"}</p>
          <p><b>Fecha fin:</b> ${info.event.endStr || "‚Äî"}</p>
          <p><b>Estado:</b> ${ev.estado || "‚Äî"}</p>
          <p><b>Progreso:</b> ${ev.progreso || 0}%</p>
          <p><b>Usuario:</b> ${ev.usuario || "‚Äî"}</p>
          <p><b>√Årea:</b> ${ev.area || "‚Äî"}</p>
          <p><b>Fecha entrega:</b> ${ev.fecha_entrega || "‚Äî"}</p>
          <p><b>Especificaci√≥n:</b><br>${ev.especificacion || "‚Äî"}</p>
        `,
        confirmButtonText: 'Cerrar',
        confirmButtonColor: '#ff2d55',
        width: '400px',
        background: '#1b1b22',
        color: '#f6f7fb'
      });
    }
  });

  calendar.render();

  // --- FORMULARIO USUARIO ---
  document.getElementById('userProjectForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const data = {
      nombre: document.getElementById('name').value.trim(),
      especificacion: document.getElementById('spec').value.trim(),
      usuario: document.getElementById('usuario').value.trim(),
      area: document.getElementById('area').value.trim(),
      fecha_entrega: document.getElementById('fechaEntrega').value || null,
      estado: "En cola" // default para user
    };

    if (!data.nombre || !data.usuario || !data.area) {
      Swal.fire({
        icon: 'warning',
        title: 'Campos incompletos',
        text: 'Por favor llena al menos Nombre, Usuario y √Årea.',
        confirmButtonColor: '#ff2d55'
      });
      return;
    }

    fetch('/api/eventos/crear-user/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
      },
      body: JSON.stringify(data),
    })
    .then(res => res.json())
    .then(res => {
      if (res.success) {
        Swal.fire({
          icon: 'success',
          title: 'Evento creado',
          text: 'Tu evento fue agregado correctamente.',
          confirmButtonColor: '#22c55e'
        });
        calendar.refetchEvents();
        document.getElementById('userProjectForm').reset();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: res.error || "No se pudo crear el evento.",
          confirmButtonColor: '#ff2d55'
        });
      }
    })
    .catch(err => {
      console.error(err);
      Swal.fire({
        icon: 'error',
        title: 'Error de conexi√≥n',
        text: 'Revisa tu red o contacta al administrador.',
        confirmButtonColor: '#ff2d55'
      });
    });
  });

  // --- BOT√ìN LIMPIAR ---
  document.getElementById('btnClearUser').addEventListener('click', () => {
    document.getElementById('userProjectForm').reset();
  });
});
</script>
</body>
</html>
